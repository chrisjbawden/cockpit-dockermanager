name: Build CANARY Packages (DEB + RPM)

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Canary package version (e.g. 1.0.6 or 1.0.6.1)"
        required: true
        default: "1.0.6"

permissions:
  contents: write

jobs:
  build-canary:
    runs-on: ubuntu-latest

    env:
      # Package identity and paths
      PKG_NAME: dockermanager-canary         # debian control Package: field
      PAYLOAD_DIR_NAME: dockermanager        # install path under /usr/share/cockpit/<this>
      BUILD_DIR: build                       # temporary build root for deb

    steps:
      # -------------------------------------------------------------------
      # 1) Checkout the canary branch
      # -------------------------------------------------------------------
      - name: Checkout repository (canary branch)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: canary
          persist-credentials: true

      # -------------------------------------------------------------------
      # 2) Prepare packaging tree (DEB)
      # -------------------------------------------------------------------
      - name: Prepare DEB packaging structure
        run: |
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR/DEBIAN"
          mkdir -p "$BUILD_DIR/usr/share/cockpit/$PAYLOAD_DIR_NAME"

          # Copy plugin files (adjust if your source dir is different)
          cp -rT "dockermanager" "$BUILD_DIR/usr/share/cockpit/$PAYLOAD_DIR_NAME"

      # -------------------------------------------------------------------
      # 3) Generate control file (CANARY)
      # -------------------------------------------------------------------
      - name: Generate DEB control file
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          cat > "$BUILD_DIR/DEBIAN/control" <<EOF
          Package: $PKG_NAME
          Version: $VERSION
          Section: admin
          Priority: optional
          Architecture: all
          Maintainer: Chris Bawden <chrisjbawden@outlook.com>
          Conflicts: dockermanager
          Replaces: dockermanager
          Description: Cockpit plugin – Docker Manager UI (CANARY channel)
           Canary channel with latest changes for testing.
          EOF

          chmod 0755 "$BUILD_DIR/DEBIAN"
          chmod 0644 "$BUILD_DIR/DEBIAN/control"

      # -------------------------------------------------------------------
      # 4) Build the .deb and provide convenient filenames
      # -------------------------------------------------------------------
      - name: Build CANARY .deb
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          dpkg-deb --build --root-owner-group "$BUILD_DIR" \
                   "${PKG_NAME}_${VERSION}_all.deb"

          # Friendly aliases for downloads / releases
          cp "${PKG_NAME}_${VERSION}_all.deb" "${PKG_NAME}-${VERSION}.deb"
          cp "${PKG_NAME}_${VERSION}_all.deb" "${PKG_NAME}.deb"

      # -------------------------------------------------------------------
      # 5) Install RPM tooling and build RPM (RHEL/Fedora)
      # -------------------------------------------------------------------
      - name: Install RPM build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm

      - name: Build CANARY .rpm
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}

          cat > rpmbuild/SPECS/dockermanager-canary.spec <<EOF
          Name:           dockermanager-canary
          Version:        $VERSION
          Release:        1%{?dist}
          Summary:        Cockpit plugin – Docker Manager UI (CANARY channel)
          License:        MIT
          BuildArch:      noarch
          Conflicts:      dockermanager
          Obsoletes:      dockermanager

          %description
          Canary channel with latest changes for testing.

          %prep

          %build

          %install
          rm -rf %{buildroot}
          mkdir -p %{buildroot}/usr/share/cockpit/dockermanager
          cp -rT dockermanager %{buildroot}/usr/share/cockpit/dockermanager

          %files
          %license LICENSE
          %dir /usr/share/cockpit
          /usr/share/cockpit/dockermanager
          EOF

          rpmbuild -bb rpmbuild/SPECS/dockermanager-canary.spec \
            --define "_topdir $PWD/rpmbuild"

          RPM_PATH=$(ls rpmbuild/RPMS/noarch/dockermanager-canary-"$VERSION"-1*.rpm | head -n 1)
          cp "$RPM_PATH" "dockermanager-canary-${VERSION}.rpm"
          cp "$RPM_PATH" "dockermanager-canary.rpm"

      # -------------------------------------------------------------------
      # 6) Move tags: versioned (-canary) and rolling (latest-canary)
      # -------------------------------------------------------------------
      - name: Move CANARY version tag to current commit
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git fetch origin
          git tag -d "v${VERSION}-canary" || true
          git push origin :refs/tags/v${VERSION}-canary || true
          git tag "v${VERSION}-canary"
          git push origin "v${VERSION}-canary" --force

      - name: Move 'latest-canary' tag to current commit
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git fetch origin
          git tag -d latest-canary || true
          git push origin :refs/tags/latest-canary || true
          git tag latest-canary
          git push origin latest-canary --force

      # -------------------------------------------------------------------
      # 7a) Create/Update versioned CANARY Release and upload packages
      # -------------------------------------------------------------------
      - name: Create/Update versioned CANARY Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}-canary
          name: "DockerManager CANARY v${{ github.event.inputs.version }}"
          body: |
            Automated CANARY release for DockerManager v${{ github.event.inputs.version }}.
            Package name: dockermanager-canary
          draft: false
          prerelease: true
          files: |
            dockermanager-canary-${{ github.event.inputs.version }}.deb
            dockermanager-canary-${{ github.event.inputs.version }}.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # -------------------------------------------------------------------
      # 7b) Create/Update rolling 'latest-canary' Release and upload packages
      # -------------------------------------------------------------------
      - name: Create/Update latest CANARY Release (rolling download)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest-canary
          name: "DockerManager CANARY – Latest"
          body: |
            Rolling canary release. Always points to the most recent build.
          draft: false
          prerelease: true
          files: |
            dockermanager-canary.deb
            dockermanager-canary.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
